<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${title != null ? title + ' - 学習進捗管理' : 'ダッシュボード - 学習進捗管理'}">ダッシュボード</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <th:block th:replace="~{fragments/layout :: footer-styles}"></th:block>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* サマリーカードのホバー効果 */
        .card.shadow-sm:hover {
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.5) !important;
            transform: translateY(-2px);
            transition: box-shadow 0.3s ease, transform 0.3s ease;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションメニューを読み込み -->
    <div th:replace="~{fragments/layout :: navbar}"></div>
    
    <div class="container mt-4">
        <!-- メッセージを読み込み -->
        <div th:replace="~{fragments/layout :: messages}"></div>
        
        <h1>ダッシュボード</h1>
        <!-- KPIサマリーカードセクション -->
        <div class="row mt-4 mb-4">
            <!-- 全体進捗率カード -->
            <div class="col-12 col-md-4 mb-3">
                <div class="card shadow-sm h-100" 
                     th:classappend="${dashboardSummary.overallProgressRate >= 80} ? 'bg-success text-white' : (${dashboardSummary.overallProgressRate >= 60} ? 'bg-warning text-dark' : 'bg-danger text-white')"
                     style="transition: box-shadow 0.3s ease;">
                    <div class="card-body text-center">
                        <i class="bi bi-graph-up" style="font-size: 2rem;"></i>
                        <h3 class="mt-2" th:if="${dashboardSummary.overallProgressRate != null}" 
                            th:text="${#numbers.formatDecimal(dashboardSummary.overallProgressRate, 1, 1)} + '%'">0%</h3>
                        <h3 class="mt-2 text-muted" th:if="${dashboardSummary.overallProgressRate == null}">--%</h3>
                        <p class="mb-2">全体進捗率</p>
                        <a th:href="@{/subjects}" class="text-decoration-none small">詳細を見る</a>
                    </div>
                </div>
            </div>
            
            <!-- 未達科目数カード -->
            <div class="col-12 col-md-4 mb-3">
                <div class="card shadow-sm h-100" 
                     th:classappend="${dashboardSummary.pendingSubjects == 0} ? 'bg-secondary text-white' : 'bg-danger text-white'"
                     style="transition: box-shadow 0.3s ease;">
                    <div class="card-body text-center">
                        <i class="bi bi-exclamation-triangle" style="font-size: 2rem;"></i>
                        <h3 class="mt-2" th:text="${dashboardSummary.pendingSubjects} + '件'">0件</h3>
                        <p class="mb-2">未達科目数</p>
                        <a th:href="@{/study-items}" class="text-decoration-none small">詳細を見る</a>
                    </div>
                </div>
            </div>
            
            <!-- 再受験必要試験数カード -->
            <div class="col-12 col-md-4 mb-3">
                <div class="card shadow-sm h-100" 
                     th:classappend="${dashboardSummary.retestExamCount == 0} ? 'bg-secondary text-white' : 'bg-danger text-white'"
                     style="transition: box-shadow 0.3s ease;">
                    <div class="card-body text-center">
                        <i class="bi bi-arrow-repeat" style="font-size: 2rem;"></i>
                        <h3 class="mt-2" th:text="${dashboardSummary.retestExamCount} + '件'">0件</h3>
                        <p class="mb-2">再受験必要試験数</p>
                        <a th:href="@{/exam-results}" class="text-decoration-none small">詳細を見る</a>
                    </div>
                </div>
            </div>
        </div>
        <!-- 科目別進捗率セクション -->
        <div class="row mt-4">
            <div class="col-12">
                <h2>科目別進捗率</h2>

                <!-- グラフを表示 -->
                <div class="card mb-4">
                    <div class="card-body">
                        <canvas id="progressChart" 
                                width="400" 
                                height="200"
                                th:attr="data-subject-names=${subjectNamesJson}, data-progress-rates=${progressRatesJson}"></canvas>
                    </div>
                </div>

                <!-- 表を表示 -->
                <div class="card">
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>科目名</th>
                                    <th>進捗率</th>
                                    <th>進捗バー</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="progress : ${subjectProgress}">
                                    <td th:text="${progress.subjectName}"></td>
                                    <td>
                                        <span th:text="${#numbers.formatDecimal(progress.progressRate, 1, 1)} + '%'"></span>
                                    </td>
                                    <td>
                                        <div class="progress">
                                            <div class="progress-bar" 
                                                 role="progressbar" 
                                                 th:style="'width: ' + ${progress.progressRate} + '%'"
                                                 th:attr="aria-valuenow=${progress.progressRate}, aria-valuemin=0, aria-valuemax=100">
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 直近の試験結果セクション -->
        <div class="row mt-4">
            <div class="col-12">
                <h2>直近の試験結果</h2>

                <!-- グラフを表示 -->
                <div class="card mb-4">
                    <div class="card-body">
                        <canvas id="examResultChart" 
                                width="400" 
                                height="200"
                                th:attr="data-taken-dates=${takenDatesJson}, data-scores=${scoresJson}"></canvas>
                    </div>
                </div>

                <!-- 表を表示 -->
                <div class="card">
                    <div class="card-body">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>科目名</th>
                                    <th>試験名</th>
                                    <th>得点</th>
                                    <th>合否</th>
                                    <th>受験日</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="examResult : ${recentExamResults}">
                                    <td th:text="${examResult.subjectName}"></td>
                                    <td th:text="${examResult.examName}"></td>
                                    <td th:text="${examResult.score}"></td>
                                    <td>
                                        <span th:if="${examResult.passed}" class="badge bg-success">合格</span>
                                        <span th:if="${!examResult.passed}" class="badge bg-danger">不合格</span>
                                    </td>
                                    <td th:text="${#temporals.format(examResult.takenAt, 'yyyy-MM-dd')}"></td>
                                </tr>
                                <tr th:if="${#lists.isEmpty(recentExamResults)}">
                                    <td colspan="5" class="text-center">試験結果がありません</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JSを読み込み -->
    <div th:replace="~{fragments/layout :: bootstrap-js}"></div>
    <div th:replace="~{fragments/layout :: footer}"></div>
    <script>
        // 進捗率の棒グラフ
        const progressCtx = document.getElementById('progressChart');
        if (progressCtx) {
            // data属性からJSON文字列を取得
            const subjectNamesJson = progressCtx.getAttribute('data-subject-names');
            const progressRatesJson = progressCtx.getAttribute('data-progress-rates');
            
            if (subjectNamesJson && progressRatesJson) {
                const subjectNames = JSON.parse(subjectNamesJson);
                const progressRates = JSON.parse(progressRatesJson);
                
                const progressData = {
                    labels: subjectNames,
                    datasets: [{
                        label: '進捗率 (%)',
                        data: progressRates,
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                };
                
                new Chart(progressCtx, {
                    type: 'bar',
                    data: progressData,
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100
                            }
                        }
                    }
                });
            }
        }

        // 試験結果の折れ線グラフ
        const examResultCtx = document.getElementById('examResultChart');
        if (examResultCtx) {
            // data属性からJSON文字列を取得
            const takenDatesJson = examResultCtx.getAttribute('data-taken-dates');
            const scoresJson = examResultCtx.getAttribute('data-scores');
            
            if (takenDatesJson && scoresJson) {
                const takenDates = JSON.parse(takenDatesJson);
                const scores = JSON.parse(scoresJson);
                
                const examResultData = {
                    labels: takenDates,
                    datasets: [{
                        label: '得点',
                        data: scores,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1
                    }]
                };
                
                new Chart(examResultCtx, {
                    type: 'line',
                    data: examResultData,
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
        }
    </script>
</body>

</html>